#!/usr/bin/bash

#################################################################
# CVE-2023-32233
#
# Purpose: In the Linux kernel through 6.3.1, a use-after-free in 
#          Netfilter nf_tables when processing batch requests can 
#          be abused to perform arbitrary read and write operations
#          on kernel memory. Unprivileged local users can obtain 
#          root privileges. This occurs because anonymous sets are
#          mishandled. This script will detect the afflicted Kernel 
#          and module
#
# Created: 5-10-2023 Inital creations by chris at uconn dot edu
#          5-16-2023 Added userspace changes by chris at uconn dot edu
#################################################################


#################################################################
# This if you set this to 1 then the script will automatically 
# block the module from loading. This is the only option at this
# time since RedHat has not released a patch
#################################################################
AUTO_REMEDIATE=0
if [ "$AUTO_REMEDIATE" -eq 1 ]; then
        echo "#######################################################"
        echo "#   WARNING WARNING WARNING WARNING WARNING WARNING   #"
        echo "#######################################################"
        echo "#                                                     #"
        echo "# Auto Remediate is enabled. This WILL make changes   #"
        echo "# to your kernel. You have 3 seconds to press CTRL+C  #"
        echo "#                                                     #"
        echo "#######################################################"
        echo "# The better option is to wait for a RHEL update to   #"
        echo "# to be released. If you require an immediate patch   #"
        echo "# then you will want to allow this script to contiune #"
        echo "#######################################################"
        sleep 3
        echo "Continuing.... "
fi

USERSPACE_REMEDIATE=1
if [ "$USERSPACE_REMEDIATE" -eq 1 ]; then
        echo "#######################################################"
        echo "#   WARNING WARNING WARNING WARNING WARNING WARNING   #"
        echo "#######################################################"
        echo "#                                                     #"
        echo "# Userspace Remediation is enabled. This WILL make    #"
        echo "# changes to your boot process.                       #"
        echo "# You have 3 seconds to press CTRL+C                  #"
        echo "#                                                     #"
        echo "#######################################################"
        sleep 3
        echo "Continuing.... "
fi

#################################################################
# Get the versions and modules
#################################################################
KERNEL_VERSION=`uname -r`
KERNEL_MAJOR_VERSION=`uname -r | cut -f1 -d\-`
NF_TABLES=`lsmod | awk ' { print $1 } '| grep -v set | grep -i nf_tables`
RHEL_VERSION=`grep -o [0-9].[0-9] /etc/redhat-release | cut -f1 -d\.`

#################################################################
# Split the string into an array
#################################################################
IFS="."
read -a VERSIONS <<< $KERNEL_MAJOR_VERSION

#################################################################
# Set some boolean variables
#################################################################
MAJOR_REL=0
MINOR_REL=0
REV_REL=0
IAMEXPOSED=0

#################################################################
# Instructions are based on the commands provided by Red Hat at
# the following URL: https://access.redhat.com/solutions/41278
# Change them at your own peril. Please note the following 
# functions will only be run if AUTO_REMEDIATE = 1
#################################################################
rhel_7_kernel () {
        cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak
        dracut --omit-drivers nf_tables -f
        MODNAME="nf_tables"; echo "omit_dracutmodules+=\" $MODNAME \"" >> /etc/dracut.conf.d/omit-$MODNAME.conf
        sed -i '/^GRUB_CMDLINE_LINUX=/s/"$/ nf_tables.blacklist=1 rd.driver.blacklist=nf_tables"/' /etc/default/grub
        grub2-mkconfig -o /boot/grub2/grub.cfg
        cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak
        sed -i '/^KDUMP_COMMANDLINE_APPEND=/s/"$/ rd.driver.blacklist=nf_tables"/' /etc/sysconfig/kdump
       kdumpctl restart
       mkdumprd -f /boot/initramfs-$(uname -r)kdump.img

       echo "You need to reboot now"
}

rhel_89_kernel () {
        cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak
        dracut --omit-drivers nf_tables -f
        MODNAME="nf_tables"; echo "omit_dracutmodules+=\" $MODNAME \"" >> /etc/dracut.conf.d/omit-$MODNAME.conf
        grubby --info DEFAULT
        grubby --info ALL
        grubby --args  "<nf_tables.blacklist=1 rd.driver.blacklist=nf_tables>" --update-kernel ALL
        cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak
        sed -i '/^KDUMP_COMMANDLINE_APPEND=/s/"$/ rd.driver.blacklist=nf_tables"/' /etc/sysconfig/kdump
        kdumpctl restart
        mkdumprd -f /boot/initramfs-$(uname -r)kdump.img

       echo "You need to reboot now"
}

#################################################################
#################################################################
## SCRIPT STARTS HERE
#################################################################
#################################################################

#################################################################
# Check the kernel versions. This is looking for less than 6.3.1
#################################################################
if [ "${VERSIONS[0]}" -eq 6 ]; then
        MAJOR_REL=1

        if [ "${VERSIONS[1]}" -le 3 ]; then
                MINOR_REL=1
                if [ "${VERSIONS[2]}" -le 1 ]; then
                        REV_REL=1
                fi
        fi
fi

#################################################################
# Since all previouls versions of the Kernel prior to 6.3.1 are
# broken. As of right now anyway. That will change when the a
# patch is released from Red Hat
#################################################################
if [ "${VERSIONS[0]}" -lt 6 ]; then
        MAJOR_REL=1
        MINOR_REL=1
        REV_REL=1
fi 

#################################################################
# Tell is if we are affected or not
#################################################################
if [ "$MAJOR_REL" -eq "1" ] && [ "$MINOR_REL" -eq "1" ] && [ "$REV_REL" -eq "1" ]; then
        echo "Found Vunlerable Kernel"
        if [ "$NF_TABLES" == "nf_tables" ]; then
                echo "CVE-2023-32233 Found. Update your Kernel now"
                IAMEXPOSED=1
        fi
else
        echo "Non Vunerable Kernel Version"
fi

if [ "$USERSPACE_REMEDIATE" -eq 1 ] && [ "$IAMEXPOSED" -eq 1 ]; then
        echo "user.max_user_namespaces=0" > /etc/sysctl.d/userns.conf
        sysctl -p /etc/sysctl.d/userns.conf

        echo "Please reboot to effect changes!!!!"
fi

if [ "$AUTO_REMEDIATE" -eq 1 ] && [ "$IAMEXPOSED" -eq 1 ]; then
        modprobe -r nf_tables
        echo "blacklist nf_tables" >> /etc/modprobe.d/local-dontload.con
        echo "install nf_tables /bin/false" >> /etc/modprobe.d/local-dontload.conf
        if [ "$RHEL_VERSION" -eq 7]; then
                rhel_7_kernel
        fi
        if [ "$RHEL_VERSION" -eq 8] || [ "$RHEL_VERSION" -eq 9]; then
                rhel_89_kernel
        fi
        if [ "$RHEL_VERSION" -eq 4] || [ "$RHEL_VERSION" -eq 5] || [ "$RHEL_VERSION" -eq 6]; then
                echo "WARNING!!!!!"
                echo "You are running a kernel that is out of compliance for Univeristy Policy."
                echo "Please upgrade now!"
        fi
fi

if [ "$AUTO_REMEDIATE" -eq 0 ] && [ "$IAMEXPOSED" -eq 1 ]; then
        echo "This system is vulnerable and any Red Hat Kernel patches"
        echo "should be applied as soon as they are available."
fi